---
title: "STAT325: named entity recognition analysis of XX"
author: "XX YOUR NAME HERE XX"
date: "2024-02-22"
date-format: iso
format: pdf
editor: source
---
  
```{r}
#| label: setup
#| include: false
library(mosaic)
library(tidyverse)
library(tidytext)
library(nametagger)
library(tictoc)
library(MobyDick)
```

```{r}
file_name <- "anno_moby.Rds"
stopifnot(file.exists(file_name))
anno <- readRDS(file_name)
```

```{r}
token_with_chapters <- anno$token |>
  mutate(chapter_number = 
           cumsum(str_detect(token, regex("^CHAPTER", ignore_case = FALSE)) & tid == 1))

entity_with_chapters <- left_join(anno$entity, 
                                  token_with_chapters, 
                                  by = c("doc_id", "sid", "tid")) |>
  select(entity_type, entity, chapter_number)
```


```{r}
token_type_summary <- token_with_chapters |>
  group_by(chapter_number) |>
  summarize(total = n(),
            NOUN_count = sum(ifelse(upos == "NOUN", 1, 0)),
            NOUN_prop = NOUN_count/total,
            ADJ_count = sum(ifelse(upos == "ADJ", 1, 0)),
            ADJ_prop = ADJ_count/total,
            VERB_count = sum(ifelse(upos == "VERB", 1, 0)),
            VERB_prop = VERB_count/total,
            PROPN_count = sum(ifelse(upos == "PROPN", 1, 0)),
            PROPN_prop = PROPN_count/total,
            CONJ_count = sum(ifelse(upos == "CCONJ" | upos == "SCONJ", 1, 0)),
            CONJ_prop = CONJ_count/total,
            .groups = "drop")

entity_type_summary_no_total <- entity_with_chapters |>
  group_by(chapter_number) |>
  summarize(person_count = sum(ifelse(entity_type == "PERSON", 1, 0)),
            location_count = sum(ifelse(entity_type == "LOC", 1, 0)),
            time_count = sum(ifelse(entity_type == "TIME", 1, 0)),
            date_count = sum(ifelse(entity_type == "DATE", 1, 0)),
            .groups = "drop")
entity_type_summary <- inner_join(entity_type_summary_no_total, token_type_summary, by = "chapter_number") |>
  select(chapter_number, total, person_count, location_count, time_count, date_count) |>
  mutate(person_prop = person_count/total,
         location_prop = location_count/total,
         time_prop = time_count/total,
         date_prop = date_count/total)

write_csv(token_with_chapters, "../token_with_chapters.csv")
write_csv(token_type_summary, "../token_type_summary.csv")
```


```{r}
unique(token_with_chapters$upos)
```
